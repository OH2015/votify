{% extends 'base.html' %}
{% block title %}詳細画面{% endblock %}

<!-- 追加リソース -->
{% block extra-static %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- jquery.inview.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/protonet-jquery.inview/1.1.2/jquery.inview.min.js"></script>
<!-- Vue3 -->
<script src="https://unpkg.com/vue@3"></script>
<!-- axios(API非同期通信) -->
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
{% endblock %}

{% block content %}
<div id="app">
    [[ message ]]
    
    <input hidden id="question_id" value="{{ question.id }}">
    <input hidden id="voted_choice_id" value="{{ voted_choice_id }}">

    {% csrf_token %}
    <div id="head">
        <!-- タイトル -->
        <h3>{{ question.title }}</h3>

        <div>
            <!-- 公開日付 -->
            <p id="created_at">公開日 {{ question.created_at|date:"Y/n/j" }}</p>
            
            <!-- ジャンル -->
            <p id="genre">#{{ question.genre }}</p>
            
            <!-- 認証レベル -->
            <p id="auth_text">{{ auth_text }}</p>
        </div>
        
    </div>
    
    
    <!-- 選択肢 -->
    <div id="content-choices" class="containner-fluid">
        <!-- 棒グラフ、円グラフ -->
        <input type="radio" name="a" v-model="graph_type" v-on:change="onChangeGraph" value="bar" id="bar" checked>
        <label class="label" for="bar">棒グラフ</label>
        <input type="radio" name="a" v-model="graph_type" v-on:change="onChangeGraph" value="pie" id="pie">
        <label class="label" for="pie">円グラフ</label>
        
        <div v-bind:class="graph_type">
            <canvas id="chart"></canvas>
        </div>
        
        {% if request.user.is_authenticated and not request.user == question.author %}
        <a id='revote' href='{% url "polls:revote" question.id %}' class="btn btn-primary">再投票</a>
        {% endif %}
    </div>
    
    <!-- 詳細 -->
    <div id="content-info">
        <a class="user-icon" href='{% url "polls:account_top" question.author.id %}'>
            <i class="fa-solid fa-circle-user fa-3x"></i>
            <span id="author">{{ question.author.username }}</span>
        </a>
        <p class="explanation">{{ question.explanation|default:"説明文はありません"|linebreaksbr }}</p>
    </div>

    <!-- コメント -->
    <div id="content-comments" class="containner-fluid">
        {% if request.user.is_authenticated %}
        <div class="comment-form">
            <textarea maxlength ="1000" id="comment-draft" v-model="comment_draft" oninput="auto_grow(this)"></textarea>
            <br>
            <button id="btn-comment" class="btn btn-primary" v-on:click="postComment()">コメント</button>
        </div>
        {% endif %}

        <div class="row" v-for="( comment,index) in comments">
            <div class="comment-container">
                <div class="comment-icon">
                    <a :href="'/' + comment.user.username + '/account_top/'"><i class="fa-solid fa-circle-user fa-2x user-icon"></i></a>
                </div>
                <div class="comment-contents">
                    <div class="comment-header">
                        <h3>[[ comment.user.username ]]</h3>
                        <span>[[ comment.get_date ]]</span>
                    </div>
                    <div class="comment-text">
                        <p>[[ comment.text ]]</p>
                    </div>
                    <div class="comment-footer">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    input[type=radio] {
        display: none;
    }
    .label {
        margin: 5px; 
        border: 1px solid #006DD9;
        border-radius: 5px;
        cursor: pointer;
        padding: 5px;
        font-weight: bold;
    }
    input[type="radio"]:checked + label {
        background: #31A9EE;/* マウス選択時の背景色を指定する */
        color: #ffffff; /* マウス選択時のフォント色を指定する */
    }
    .pie{
        margin: auto;
        margin-bottom: 50px;
        max-width: 500px;
    }
    #app{
        margin: auto;
        max-width: 700px;
    }
    #head{
        display: flex;
        justify-content: space-between;
    }
    canvas{
        width: 100%;
    }
    #created_at,#auth_text,#genre{
        font-size: 12px;
        text-align: right;
        right: 0px;
    }

    #content-choices{
        width:100%;
        margin-top: 30px;
    }
    #content-info{
        padding-top: 30px;
        border-top: solid gray 1px;
    }
    #revote{
        margin-bottom: 20px;
    }
    .user-icon{
        text-decoration: none;
        color: black;
    }
    #author{
        font-size: 20px;
        padding: 10px;
    }
    .explanation{
        font-size: 14px;
        white-space: pre-wrap;
        padding-top: 10px;
    }
    #content-comments{
        border-top: solid gray 1px;
        width: 100%;
        margin-top:50px;
    }
    .comment-form{
        padding-bottom: 30px;
        border-bottom: solid gray 1px;
    }
    .row{
        margin-top: 20px;
    }

    .comment-form{
        margin-top:30px;
    }
    #comment-draft{
        max-width: 500px;
        width:100%;
        height:28px;
        resize:none;
        overflow: hidden;
    }
    .comment-container{
        display: flex;
    }
    .comment-icon{margin-right: 10px;}
    .comment-icon a{
        color: black;
    }
    .comment-text p {
        white-space: pre-wrap;
        font-size: 13px;
    }
</style>

<script>
    function auto_grow(element) {
        element.style.height = "5px";
        element.style.height = (element.scrollHeight)+"px";
    }

    Vue.createApp({
        data() {
            return {
                // 画面表示メッセージ
                message: "",
                // 表示中の質問ID
                question_id: 0,
                // 投稿した選択肢ID
                voted_choice_id:0,
                // グラフ種類
                graph_type:'bar',
                // コメント下書き
                comment_draft: "",
                // 選択肢リスト
                choices: [],
                // コメントリスト
                comments: [],
                // グラフの設定
                graph_config:{},
            }
        }
        ,methods: {
            // コメント投稿
            postComment(event){
                if(!this.comment_draft)return;
                
                axios.defaults.xsrfCookieName = 'csrftoken'
                axios.defaults.xsrfHeaderName = "X-CSRFTOKEN"
                
                let params = new URLSearchParams();
                params.append('text', this.comment_draft);
                axios.post('/post_comment/' + this.question_id + '/', params)
                .then(res => {
                    this.comment_draft = ""
                    setTimeout( function() {    
                        auto_grow(document.getElementById('comment-draft'))
                    }, 1 );
                    this.getComments()
                })
                .catch(error => {
                    this.message = "コメントの投稿に失敗しました" + error.response
                })
            },
            // コメント取得
            getComments(){
                axios.get("/api/comments/" + this.question_id)
                .then(res => {
                    this.comments = res.data
                })
                .catch(res => {
                    this.message = "コメントの取得に失敗しました" + res.data
                })
            },
            // グラフ描画
            renderGraph(){
                Chart.defaults.font.size = screen.width / 100 + 4;
                let labels = []
                let other_votes = []
                let total_votes = []
                let myvotes = []
                this.choices.forEach(element => {
                    labels.push(element.choice_text)
                    total_votes.push(element.votes)
                    if(element.id == this.voted_choice_id){
                        myvotes.push(1)
                        other_votes.push(element.votes-1)
                    }else{
                        myvotes.push(0)
                        other_votes.push(element.votes)
                    }
                });

                let config = null
                // 棒グラフ
                if(this.graph_type == 'bar'){
                    config = {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'その他(' + other_votes.reduce((sum,el) => sum + el,0) + ')',
                                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                    borderColor: 'rgb(54, 162, 235)',
                                    borderWidth: 1,
                                    data: other_votes,
                                    barPercentage:0.8,
                                },
                                {
                                    label: '自分(' + myvotes.reduce((sum,el) => sum + el,0) + ')',
                                    backgroundColor: 'rgba(248, 248, 154, 0.2)',
                                    borderColor: 'rgb(160, 162, 160)',
                                    borderWidth: 1,
                                    data: myvotes,
                                    barPercentage:0.8,
                                },
                            ]
                        },
                        options: {
                            indexAxis: 'y',
                            scales:{
                                x:{
                                    display:false,
                                    stacked: true,
                                },
                                y:{
                                    stacked: true,
                                }
                            },               
                            animation:{
                                duration:3000,
                            },
                        }
                    }
                // 円グラフ
                }else if(this.graph_type == 'pie'){
                    config = {
                        type: 'pie',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    backgroundColor: ["#5a79ba", "#68be8d", "#cc7eb1", "#f6ad49", "#7FDBFF", "#B10DC9", "#FFDC00", "#001f3f", "#39CCCC", "#01FF70", "#85144b", "#F012BE", "#3D9970", "#111111", "#AAAAAA"],
                                    borderWidth: 1,
                                    data: total_votes,
                                    barPercentage:0.8,
                                },
                            ]
                        },
                        options: {
                            animation:{
                                duration:3000,
                            },
                        },
                    }
                }

                // チャート生成
                window.chart = new Chart(
                    document.getElementById('chart'),
                    config
                );
            },
            // グラフタイプ変更時
            onChangeGraph(){
                // グラフ削除
                if(window.chart){
                    window.chart.destroy()
                }
                // グラフ再描画
                this.renderGraph()
            }

        }
        ,mounted() {
            // question_id取得
            this.question_id = document.getElementById('question_id').value;
            // 投票済みchoice_id取得
            this.voted_choice_id = document.getElementById('voted_choice_id').value;

            // 選択肢取得
            axios.get("/api/choices/" + this.question_id,{
                params:{sort: true}
            })
            .then(res => {
                this.choices = res.data
                // グラフ描画
                this.renderGraph();
            })
            .catch(res => {
                this.message = "選択肢情報の取得に失敗しました" + res.data
            })
            // コメント取得
            this.getComments()


        }
        ,computed: {
            voteSum(){ return this.choices.reduce((sum,el) => sum + el.votes,0)}
        }
        // djangoのテンプレートエンジンと競合するので{}から[]に変更
        ,delimiters: ['[[', ']]']
    }).mount('#app')
</script>
{% endblock %}